/*
 * Copyright (c) 2019 by European Commission
 *
 * Licensed under the EUPL, Version 1.2 or - as soon they will be
 * approved by the European Commission - subsequent versions of the
 * EUPL (the "Licence");
 * You may not use this work except in compliance with the Licence.
 * You may obtain a copy of the Licence at:
 * https://joinup.ec.europa.eu/page/eupl-text-11-12
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the Licence is distributed on an "AS IS" basis,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
 * implied.
 * See the Licence for the specific language governing permissions and
 * limitations under the Licence
 */
package eu.eidas.node.auth.connector;

import eu.eidas.auth.commons.WebRequest;
import eu.eidas.auth.commons.attribute.ImmutableAttributeMap;
import eu.eidas.auth.commons.exceptions.InternalErrorEIDASException;
import eu.eidas.auth.commons.light.ILightRequest;
import eu.eidas.auth.commons.protocol.IAuthenticationRequest;
import eu.eidas.auth.commons.protocol.IAuthenticationResponse;
import eu.eidas.auth.commons.protocol.IRequestMessage;
import eu.eidas.auth.commons.protocol.eidas.impl.EidasAuthenticationRequest;
import eu.eidas.auth.commons.tx.AuthenticationExchange;
import eu.eidas.auth.commons.tx.StoredAuthenticationRequest;
import eu.eidas.auth.commons.tx.StoredLightRequest;
import eu.eidas.auth.engine.ProtocolEngineI;

import javax.annotation.Nonnull;
import javax.cache.Cache;
import javax.servlet.http.HttpServletRequest;
import java.util.Map;

/**
 * Interface for working with SAMLObjects.
 *
 * @author ricardo.ferreira@multicert.com, renato.portela@multicert.com, luis.felix@multicert.com,
 *         hugo.magalhaes@multicert.com, paulo.ribeiro@multicert.com
 * @version $Revision: 1.34 $, $Date: 2010-11-18 23:17:50 $
 */
public interface ICONNECTORSAMLService {

    /**
     * Process the Service Provider Request received from the specific and transform the light request received.
     *
     * @param lightRequest The LightRequest.
     * @param webRequest the instance of the {@link WebRequest}
     * @return An authentication request created from the SAML token.
     * @see EidasAuthenticationRequest
     * @see Map
     */
    IAuthenticationRequest processSpRequest(ILightRequest lightRequest, WebRequest webRequest);

    /**
     * Process the token received the Proxy service.
     *
     * @param webRequest the webRequest to extract the SAMLtoken
     * @param connectorRequestCorrelationMap The  map contains the authentication request issued by the connector from
     * the one from the ServiceProvider.
     * @param specificSpRequestCorrelationMap The map contains the {@link ILightRequest} generated by the Specific
     * module from the ServiceProvider's authentication request.
     * @return The authentication request and response pair.
     * @throws InternalErrorEIDASException the propagated error processing error
     * @see AuthenticationExchange
     */
    AuthenticationExchange processProxyServiceResponse(@Nonnull WebRequest webRequest,
                                                       @Nonnull
                                                               Cache<String, StoredAuthenticationRequest> connectorRequestCorrelationMap,
                                                       @Nonnull
                                                               Cache<String, StoredLightRequest> specificSpRequestCorrelationMap)
            throws InternalErrorEIDASException;

    /**
     * Creates a SAML Authentication Request to send to Service.
     *
     * @param webRequest the instance of the {@link WebRequest}
     * @param request the instance of the {@link IAuthenticationRequest}
     * @return A new authentication request with the SAML token embedded.
     * @see EidasAuthenticationRequest
     */
    IRequestMessage generateServiceAuthnRequest(@Nonnull WebRequest webRequest,
                                                @Nonnull IAuthenticationRequest request);

    /**
     * Generates a response's SAML token in case of error. Deprecated, uses to build a fake AuthRequest when it is not
     * available - for example we have HttpRequest
     *
     * @param httpServletRequest The http request that gave origin to this response.
     * @param destination The request's destination.
     * @param statusCode The status code.
     * @param subCode The sub status code.
     * @param message The error message.
     * @return The response's SAML token in the format of byte array.
     */
    byte[] generateErrorAuthenticationResponse(HttpServletRequest httpServletRequest,
                                               String destination,
                                               String statusCode,
                                               String subCode,
                                               String message);

    /**
     * Generates a response's SAML token in case of error.
     *
     * @param origRequest The Auth request that gave origin to this response.
     * @param ipUserAddress The citizen's IP address.
     * @param idpResponse response from IdP
     * @param message The error message.
     * @return The response's SAML token in the format of byte array.
     */
    byte[] generateErrorAuthenticationResponse(IAuthenticationRequest origRequest,
                                               String ipUserAddress,
                                               IAuthenticationResponse idpResponse,
                                               String message);

    /**
     * Generates a response's SAML token in case of error.
     *
     * @param origRequest The Auth request that gave origin to this response.
     * @param ipUserAddress The citizen's IP address.
     * @param statusCode The status code.
     * @param subCode The sub status code.
     * @param message The error message.
     * @return The response's SAML token in the format of byte array.
     */
    byte[] generateErrorAuthenticationResponse(IAuthenticationRequest origRequest,
                                               String ipUserAddress,
                                               String statusCode,
                                               String subCode,
                                               String message);

    /**
     * Checks whether the attribute map contains at least one of the mandatory eIDAS attribute set (either for a natural
     * [person or for a legal person)
     *
     * @param attributes the instance of {@link ImmutableAttributeMap} holding the attributes
     * @return true if the attribute map contains at least one of the mandatory eIDAS attribute set
     */
    boolean checkMandatoryAttributes(@Nonnull ImmutableAttributeMap attributes);

    /**
     * Checks whether the attribute map satifisfies the rule of representation
     *
     * @param attributes the instance of {@link ImmutableAttributeMap} holding the attributes
     * @return true if the attribute map satifisfies the rule of representation
     */
    boolean checkRepresentativeAttributes(@Nonnull ImmutableAttributeMap attributes);

    /**
     * Returns used ProtocolEngine
     *
     * @return instance of ProtocolEngine
     */
    ProtocolEngineI getSamlEngine();

}
